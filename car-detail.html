<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title id="seo-title"></title>
  <meta name="description" id="seo-desc">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta property="og:title" id="og-title" content="">
  <meta property="og:description" id="og-desc" content="">
  <meta property="og:image" id="og-image" content="">
  <meta property="og:type" content="product">
  <meta property="og:site_name" content="ครูหนึ่งรถสวย รถมือสองเชียงใหม่">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" id="tw-title" content="">
  <meta name="twitter:description" id="tw-desc" content="">
  <meta name="twitter:image" id="tw-image" content="">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .main-img { width:100%; border-radius:14px; box-shadow:0 4px 20px #0002;}
    .gallery { display:flex; gap:5px; margin:10px 0;}
    .gallery img { width:80px; height:60px; object-fit:cover; border-radius:8px; border:2px solid #eee; cursor:pointer;}
    .gallery img.selected{ border-color:#ea671a;}
    .car-status.sold { color: #fff; background: #e1412e; border-radius: 7px; padding:2px 10px;}
    .car-status.booked { color: #fff; background: #f9a500; border-radius: 7px; padding:2px 10px;}
    .car-status.free { color: #fff; background: #06c755; border-radius: 7px; padding:2px 10px;}
  </style>
</head>
<body>
<div class="container my-3">
  <div class="card p-4">
    <img id="main-img" class="main-img mb-2" src="">
    <div class="gallery mb-2" id="gallery"></div>
    <h1 class="h4 mb-2" id="car-title"></h1>
    <div class="car-price fs-5" id="car-price"></div>
    <div id="car-status" class="car-status mb-2"></div>
    <div class="mb-2" id="car-desc"></div>
    <div class="mb-3 text-muted" id="car-updated"></div>
    <div class="btn-group d-flex">
      <a class="btn btn-success" target="_blank" href="https://lin.ee/zXaTVvJ">สอบถามผ่าน LINE</a>
      <a class="btn btn-primary" target="_blank" href="https://facebook.com/KN2car/">ดูรถบน Facebook</a>
      <a class="btn btn-warning" href="index.html">← กลับหน้ารวมรถ</a>
    </div>
  </div>
</div>
<script>
const SHOPIFY_DOMAIN = "kn-goodcar.com";  // <--- ใส่ domain Shopify
const STOREFRONT_ACCESS_TOKEN = "bb70cb008199a94b83c98df0e45ada67"; // <--- token Shopify

function getHandle(){
  const params = new URLSearchParams(window.location.search);
  return params.get("handle");
}
function getStatusClass(status){
  if(!status) return "";
  if(status.includes("ขาย")) return "sold";
  if(status.includes("จอง")) return "booked";
  if(status.includes("ฟรีดาวน์")) return "free";
  return "";
}
async function fetchCarDetail(handle) {
  const query = `{ productByHandle(handle: "${handle}") {
    title vendor updatedAt description
    images(first:10){ edges{ node{ url } } }
    variants(first:1){ edges{ node{ price{ amount } } } }
  }}`;
  const res = await fetch(`https://${SHOPIFY_DOMAIN}/api/2023-10/graphql.json`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Shopify-Storefront-Access-Token": STOREFRONT_ACCESS_TOKEN
    },
    body: JSON.stringify({ query })
  });
  const json = await res.json();
  return json.data.productByHandle;
}
function setMainImg(src){
  document.getElementById('main-img').src = src;
  document.querySelectorAll('.gallery img').forEach(i=>i.classList.remove('selected'));
  [...document.querySelectorAll('.gallery img')].find(i=>i.src===src).classList.add('selected');
}
(async function(){
  const handle = getHandle();
  if(!handle) { document.body.innerHTML = "ไม่พบข้อมูลรถ"; return; }
  const car = await fetchCarDetail(handle);
  if(!car){ document.body.innerHTML = "ไม่พบข้อมูลรถ"; return; }
  document.title = car.title + " | ครูหนึ่งรถสวย รถมือสองเชียงใหม่";
  document.getElementById('seo-title').textContent = car.title + " | รถมือสองเชียงใหม่";
  document.getElementById('seo-desc').setAttribute("content", car.description);
  document.getElementById('car-title').textContent = car.title;
  document.getElementById('car-price').textContent = `฿${Number(car.variants.edges[0]?.node.price.amount||0).toLocaleString()}`;
  document.getElementById('car-desc').textContent = car.description;
  document.getElementById('car-updated').textContent = "อัปเดตล่าสุด: "+new Date(car.updatedAt).toLocaleDateString('th-TH');
  // status
  let status = "ฟรีดาวน์";
  if(car.description.includes("ขายแล้ว")) status = "ขายแล้ว";
  else if(car.description.includes("จอง")) status = "จองแล้ว";
  document.getElementById('car-status').textContent = status;
  document.getElementById('car-status').className = "car-status mb-2 "+getStatusClass(status);

  // รูป + แกลเลอรี่
  const images = car.images.edges.map(e=>e.node.url);
  document.getElementById('main-img').src = images[0];
  document.getElementById('gallery').innerHTML = images.map((img,i)=>`
    <img src="${img}" onclick="setMainImg('${img}')" class="${i===0?'selected':''}">
  `).join('');
  window.setMainImg = setMainImg;

  // meta/OG/twitter auto
  document.getElementById('og-title').setAttribute("content", car.title + " | รถมือสองเชียงใหม่");
  document.getElementById('og-desc').setAttribute("content", car.description);
  document.getElementById('og-image').setAttribute("content", images[0]);
  document.getElementById('tw-title').setAttribute("content", car.title + " | รถมือสองเชียงใหม่");
  document.getElementById('tw-desc').setAttribute("content", car.description);
  document.getElementById('tw-image').setAttribute("content", images[0]);

  // JSON-LD Schema
  const schemaProduct = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": car.title,
    "image": images,
    "description": car.description,
    "brand": { "@type": "Brand", "name": car.vendor || car.title.split(' ')[0] },
    "offers": {
      "@type": "Offer",
      "priceCurrency": "THB",
      "price": car.variants.edges[0]?.node.price.amount || "0",
      "availability": status.includes('ขาย') ? "https://schema.org/SoldOut" : "https://schema.org/InStock"
    }
  };
  let el = document.getElementById('product-json');
  if (!el) {
    el = document.createElement('script');
    el.type = 'application/ld+json';
    el.id = 'product-json';
    document.head.appendChild(el);
  }
  el.textContent = JSON.stringify(schemaProduct, null, 2);
})();
</script>
</body>
</html>